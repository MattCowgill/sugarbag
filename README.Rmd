---
output: github_document
---

<!-- README.md is generated from this README.Rmd. Please edit this file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
library(dplyr)
library(tidyr)
library(ggplot2)
```

# sugarbag

[![Travis-CI Build Status](https://travis-ci.org/srkobakian/sugarbag.svg?branch=master)](https://travis-ci.org/srkobakian/sugarbag)


The **sugarbag** package creates tesselated hexagon maps for visualising geo-spatial data. Hexagons of equal size are positioned to best preserve relationships to focal points, and minimise distance from their actual location. This method provides an alternative to cartograms that allows all regions to be compared on the same visual scale.

Maps containing regions with a few small and densely populated areas are extremely distorted in cartograms. An example of this is a population cartogram of Australia, which distorts the map into an unrecognisable shape. The technique implemented in this package is particularly useful for these regions.



## Installation

<!-- You can install the released version of sugarbag from [CRAN](https://CRAN.R-project.org) with: -->

<!-- ``` r -->
<!-- install.packages("sugarbag") -->
<!-- ``` -->

You can install the development version from GitHub using

```{r, eval = FALSE}
# install.packages("remotes")
# remotes::install_github("srkobakian/sugarbag")
```

## Getting started

Refer to pkgdown site: https://srkobakian.github.io/sugarbag/


```{r aus-anim, warning = FALSE, message = FALSE}
library(sugarbag)
library(eechidna)

# We could use create centroids to find centroid for each area.
# This has been done for us and is stored in nat_data16.

# Find the longitude and latitude centroid for each region or area
centroids <- nat_data16 %>% select(elect_div, longitude = long_c, latitude = lat_c)

# Create a grid of hexagons to allocate centroid on to
grid <- create_grid(centroids = centroids, hex_size = 1, buffer_dist = 5)

# Allocate the centroids to the hexagon grid
# We have the same amount of rows, as individual regions
hex_allocated <- allocate(centroids = centroids,
  sf_id = "elect_div",
  hex_grid = grid,
  hex_size = 1, # same size used in create_grid
  hex_filter = 10,
  focal_points = capital_cities,
  width = 30, verbose = TRUE) # same column used in create_centroids

# We now have 6 points per region, one for each point of a hexagon
h1 <- hex_allocated %>%
  fortify_hexagon(hex_size = 1, sf_id = "elect_div") %>%
  left_join(nat_data16, by = "elect_div") %>% mutate(poly_type = "hex")

# When plotting, the polygons are needed, rather than single centroid points.
# We can apply the same function as above, to find 6 points per centroid
p1 <- nat_data16 %>% 
  select(elect_div, hex_long = long_c, hex_lat = lat_c) %>%
  fortify_hexagon(hex_size = 0.1, sf_id = "elect_div") %>%
  left_join(nat_data16, by = "elect_div") %>%
  mutate(poly_type = "geo")

hex_anim <- h1 %>% 
  select(state, elect_div, long, lat, id = id.x, poly_type) %>% 
  left_join(p1 %>% distinct(elect_div, polygon), by = "elect_div")
geo_anim <- p1 %>% 
  select(elect_div, long, lat, poly_type)
anim_aus <- bind_rows(hex_anim, geo_anim)

# Join demographics data from 2016 Census
anim_aus <- anim_aus %>% 
  left_join(abs2016 %>% select(elect_div = DivisionNm, AusCitizen, CurrentlyStudying, MedianFamilyIncome, Unemployed, Renting))
```

```{r plot_facet, dpi = 300}
anim_aus %>% 
  ggplot(aes(x=long, y=lat, group = interaction(elect_div))) +
  geom_polygon(aes(fill = Renting)) +
  coord_equal() + 
  theme_void() + 
  scale_fill_continuous(type = "viridis") +
  guides(fill = guide_colourbar(title = NULL)) + 
  #theme(legend.position = "bottom") +
  facet_wrap(~poly_type)
```


```{r}
library(gganimate)
anim_aus %>% 
  ggplot(aes(x=long, y=lat, group = interaction(elect_div))) +
  geom_polygon(aes(fill = CurrentlyStudying)) + 
  coord_equal() + 
  theme_void() +
  scale_fill_continuous(type = "viridis") +
  guides(fill = guide_legend(title = NULL)) + 
  theme(legend.position = "bottom") +
  transition_states(poly_type)
```

```{r usa-anim, echo = FALSE, message = FALSE}
# US states

library(spData)
library(sugarbag)
library(tidyverse)

# US centroids from https://www2.census.gov/geo/docs/reference/cenpop2010/CenPop2010_Mean_ST.txt

us_states_c <- readr::read_csv("https://www2.census.gov/geo/docs/reference/cenpop2010/CenPop2010_Mean_ST.txt") %>%
  dplyr::select(state = STNAME, longitude = LONGITUDE, latitude = LATITUDE, population = POPULATION)

US_hex <- create_hexmap(us_states, sf_id = "NAME", focal_points = tibble(USA = "center", longitude = -99.4, latitude = 39.4), hex_size = 2.5)

p1 <- fortify_sfc(us_states) %>% mutate(poly_type = "geo")

h1 <- US_hex %>%
  fortify_hexagon(hex_size = 2.5, sf_id = "NAME") %>%
  left_join(us_states) %>% mutate(poly_type = "hex")

hex_anim <- h1 %>% 
  select(NAME, REGION, long, lat, poly_type) %>% 
  left_join(p1 %>% distinct(NAME, polygon), by = "NAME")
geo_anim <- p1 %>% 
  select(NAME, REGION, long, lat, polygon, poly_type)
anim_usa <- bind_rows(hex_anim, geo_anim)

library(gganimate)
anim_usa %>% 
  ggplot(aes(x=long, y=lat, group = interaction(polygon, NAME))) +
  geom_polygon(aes(fill = REGION)) +
  geom_polygon(data = geo_anim %>% select(-poly_type), fill = "grey40", alpha = 0.05) + 
  coord_equal() + 
  theme_void() + 
  guides(fill = guide_legend(title = NULL)) + 
  theme(legend.position = "bottom") +
  transition_states(poly_type)
```


```{r tas-anim, echo = FALSE, message = FALSE, eval = FALSE}
centroids <- create_centroids(tas_sa2, sf_id = "SA2_5DIG16")

grid <- create_grid(centroids = centroids, hex_size = 0.2, buffer_dist = 1.2)

hex_allocated <- allocate(centroids = centroids,
                          sf_id = "SA2_5DIG16",
                          hex_grid = grid,
                          hex_size = 0.2, # same size used in create_grid
                          hex_filter = 10,
                          focal_points = capital_cities,
                          width = 30, verbose = TRUE) # same column used in create_centroids

h1 <- hex_allocated %>%
  fortify_hexagon(hex_size = 0.2, sf_id = "SA2_5DIG16") %>%
  left_join(., tas_sa2) %>% mutate(poly_type = "hex")

p1 <- fortify_sfc(tas_sa2) %>% mutate(poly_type = "geo")

hex_anim <- h1 %>% 
  select(SA4_NAME16, SA2_5DIG16, 	
SA2_NAME16, long, lat, poly_type) %>% 
  left_join(p1 %>% distinct(SA2_5DIG16, polygon), by = "SA2_5DIG16")
geo_anim <- p1 %>% 
  select(SA4_NAME16, SA2_5DIG16, 	
SA2_NAME16, long, lat, polygon, poly_type)
anim_tas <- bind_rows(hex_anim, geo_anim) %>% left_join(homeless)


library(gganimate)
anim_tas %>% 
  ggplot(aes(x=long, y=lat, group = interaction(polygon, SA2_5DIG16))) +
  geom_polygon(aes(fill = SA4_NAME16)) +
  geom_polygon(data = geo_anim %>% select(-poly_type), fill = "grey40", alpha = 0.05) + 
  coord_equal() + 
  theme_void() + 
  guides(fill = guide_legend(title = NULL)) + 
  theme(legend.position = "bottom") +
  transition_states(poly_type)
```
